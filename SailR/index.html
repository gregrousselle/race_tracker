<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Meta -->
    <link rel="apple-touch-icon" sizes="57x57" href="static/favicon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="static/favicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="static/favicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="static/favicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="static/favicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="static/favicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="static/favicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="static/favicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="static/favicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="static/favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="static/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="static/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="static/favicon/favicon-16x16.png">
    <link rel="manifest" href="static/favicon/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-E2XG6MBSDG"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-E2XG6MBSDG');
    </script>

    <meta name="twitter:image" content="static/img/share.png">
		<meta name="google-site-verification" content="k8kJi61_0jGlwWCuvUGDptZN8vge3fufTIGPZ7Napfk" />
		<meta name="twitter:title" content="Tracker pour suivre les courses nautiques en temps réel - Vendée Globe 2020/21">
		<meta name="twitter:description" content="Tracker pour suivre les courses nautiques en temps réel - Vendée Globe 2020/21">
		<meta name="description" content="Sailing Race Tracker - Vendée Globe 2020/21" />
		<meta name="author" content="Sailing Race Tracker" />
		<meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="Sailing Race Tracker">
    

    <title>SailR</title>
    <script src="static/jquery-3.5.1.min.js" ></script>
    <!-- Leaflet -->
    <link rel="stylesheet" href="static/leaflet/leaflet.css"/>
    <script src="static/leaflet/leaflet.js" ></script>
    <!--leaflet-velocity-->
    <link rel="stylesheet" href="static/velocity/leaflet-velocity.css" />
    <script src="static/velocity/leaflet-velocity.js"></script>
    <script src="static/velocity/IE_workarounds.js"></script>
    <!-- add Leafleet rotate -->
    <script type="text/javascript" src="static/leaflet.rotatedMarker.js"></script>
    <!-- add Leafleet terminator -->
    <script src="https://unpkg.com/@joergdietrich/leaflet.terminator"></script>
    <!-- add Leafleet sidebar -->
    <link rel="stylesheet" href="static/leaflet-sidebar/src/L.Control.Sidebar.css" />
    <script src="static/leaflet-sidebar/src/L.Control.Sidebar.js"></script>
    <!--for timeslider-->
    <script type="text/javascript" src="static/timedimension/iso8601.min.js"></script>
    <script type="text/javascript" src="static/timedimension/leaflet.timedimension.noLayers.src.js"></script>
    <link rel="stylesheet" href="static/timedimension/leaflet.timedimension.control.min.css" />
    <!-- load variable values from server-->
    <script type="text/javascript" src="https://weather.openportguide.org/weather/javascript_vars.js"></script>
    <script type="text/javascript" src="https://weather.openportguide.org/weather/javascript_vars_rtofs.js"></script>
    <!-- add Polyline -->
	  <link rel="stylesheet" href="https://ppete2.github.io/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.css" />
    <script src="https://ppete2.github.io/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.js"></script>
    <!-- add Navionics -->
    <link rel="stylesheet" href="https://webapiv2.navionics.com/dist/webapi/webapi.min.css" >
    <script type="text/javascript" src="https://webapiv2.navionics.com/dist/webapi/webapi.min.no-dep.js"></script>
    <!-- add chartjs -->
    <link rel="stylesheet" href="static/chartjs/Chart.min.css" >
    <script type="text/javascript" src="static/chartjs/Chart.min.js"></script>
    <script type="text/javascript" src="static/chartjs-plugin-annotation.js"></script>
    <!-- add timer -->
    <script type="text/javascript" src="static/easytimer.min.js"></script>
    <!-- fontello -->
    <link rel="stylesheet" href="static/fontello/css/fontello.css" />
    <!-- Custom -->
    <link rel="stylesheet" href="static/style.css" />
  </head>
  <body>
    <div class="black-container">
      <div class="container txtheader">Cartographie non officielle du <span class="blue">Vendée-Globe 2020/2021</span> - <a target="_blank" href="https://github.com/volodiaja/race_tracker/">Github</a></div>
      </div>
      <div id="map"></div>
      <div id="footer" class="black-container">
        <div class="container chronodata">
          <div id="timer">
            <div>Chronométre</div>
            <div><span class="blue">J+</span><span class="days blue">00</span> <span class="hours">00</span><span class="blue">:</span><span class="minutes">00</span><span class="blue">:</span><span class="seconds">00</span></div>
          </div>
          <div>
            <div>Skippers en course</div>
            <div><span class="blue" id="skipperCount">33</span> / 33</div>
        </div>
      </div>
      <div id="sidebar">
        <button id="close"><i class="icon-cancel-circle"></i></button>
       <div class="header">
          <img id="data_skipper_pict"  src="static/img/avatar/default.jpg" class="skipper_pict" />
          <div>
            <h1 id="data_skipper">--</h1>
            <h2><span id="data_team">--</span><span id="data_foiler" class="boat-type">--</span><h2>
          </div>
       </div>
       <div class="bloc metrics">
         <div><div>Position</div><div id="data_postion">--</div></div>
         <div><div>Vitesse</div><div><span  id="data_speed">--</span> kt</div></div>
         <div><div>Cap</div><div id="data_heading">--</div></div>
       </div>
       <div class="bloc metrics">
         <div><div>Vent</div>
         <div class="withicon">
           <div class="icondata" id='data_direction'>
            <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
            viewBox="0 0 511.998 511.998" style="enable-background:new 0 0 511.998 511.998;" xml:space="preserve">
              <path d="M505.743,6.249c-6.08-6.101-15.211-7.893-23.168-4.672l-469.333,192c-8.768,3.605-14.123,12.544-13.12,21.973
                c0.981,9.429,8.064,17.067,17.387,18.773l220.139,40.021l40.043,220.139c1.685,9.323,9.323,16.405,18.752,17.408
                c0.747,0.064,1.493,0.107,2.219,0.107c8.576,0,16.448-5.184,19.755-13.269l192-469.333
                C513.658,21.459,511.823,12.329,505.743,6.249z"/>
            </svg>
          </div>
           <span id="data_vent">--</span>
          </div>
        </div>

         <div><div>Pluie</div>
          <div class="withicon">
            <div  class="icondata">
              <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
              viewBox="0 0 410.823 410.823" style="enable-background:new 0 0 410.823 410.823;" xml:space="preserve">
               <path d="M5.595,254.875c-17.185,46.513,6.539,98.118,53.048,115.317c46.474,17.203,98.103-6.577,115.312-53.046
                 c17.175-46.468-31.479-173.544-31.479-173.544S22.821,208.372,5.595,254.875z M35.054,273.141
                 c5.685,50.553,34.358,67.908,34.358,67.908C18.311,325.793,35.054,273.141,35.054,273.141z"/>
               <path d="M395.391,259.702c0,0-52.531,28.454-60.083,48.864c-7.54,20.411,2.873,43.066,23.285,50.616
                 c20.399,7.535,43.06-2.884,50.614-23.278C416.761,315.505,395.391,259.702,395.391,259.702z M348.232,316.572
                 c2.503,22.202,15.086,29.817,15.086,29.817C340.889,339.719,348.232,316.572,348.232,316.572z"/>
               <path d="M368.837,177.115c14.061-38.057-25.778-142.083-25.778-142.083s-97.944,53.086-112.03,91.106
                 c-14.074,38.028,5.364,80.34,43.398,94.384C312.473,234.624,354.746,215.17,368.837,177.115z M255.121,141.088
                 c4.663,41.38,28.137,55.596,28.137,55.596C241.416,184.205,255.121,141.088,255.121,141.088z"/>
               </svg>
          </div>
            <span id="data_pluie">--</span>
          </div>
         </div>
         <div><div>Nuages</div>
         <div class="withicon">
          <div  class="icondata">
            <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
              viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve">
              <path d="m255.736 186.569c2.627-.214 5.264-.322 7.902-.322 22.617 0 43.44 7.823 59.911 20.902 6.253-1.256 12.695-1.915 19.259-1.915 41.721 0 78.592 26.539 92.5 64.828 2.763-.233 5.538-.35 8.315-.35 8.377 0 16.511 1.055 24.28 3.035 5.46-15.417 8.443-31.996 8.443-49.26 0-81.581-66.371-147.951-147.951-147.951-48.212 0-91.108 23.184-118.136 58.985 20.734 11.035 37.196 29.435 45.477 52.048z"/>
              <path d="m241.994 269.712c2.777 0 5.553.117 8.314.35 7.368-20.283 21.182-37.267 38.746-48.757-7.835-3.252-16.417-5.057-25.416-5.057-5.15 0-10.285.591-15.26 1.758-3.948.926-8.104.214-11.519-1.976-3.415-2.188-5.798-5.667-6.605-9.641-6.263-30.814-33.674-53.179-65.179-53.179-31.504 0-58.915 22.365-65.179 53.18-.808 3.975-3.19 7.453-6.605 9.641-3.414 2.188-7.569 2.903-11.519 1.975-4.974-1.167-10.108-1.758-15.26-1.758-36.674 0-66.512 29.837-66.512 66.513s29.838 66.514 66.514 66.514h78.917c8.804-45.276 48.751-79.563 96.563-79.563z"/>
              <path d="m443.624 299.712c-5.296 0-10.573.608-15.688 1.807-3.948.927-8.104.214-11.519-1.975-3.415-2.188-5.798-5.667-6.605-9.642-6.438-31.677-34.617-54.669-67.004-54.669-32.386 0-60.564 22.992-67.004 54.669-.808 3.975-3.19 7.453-6.605 9.641-3.415 2.19-7.57 2.901-11.52 1.975-5.112-1.199-10.39-1.807-15.686-1.807-37.702 0-68.376 30.673-68.376 68.376s30.674 68.376 68.376 68.376h201.63c37.703 0 68.376-30.673 68.376-68.376s-30.672-68.375-68.375-68.375z"/>
              </svg>
          </div>
          <span id="data_nuage">--</span>
        </div>
       </div>
       </div>
       <div class="bloc">
          <h2 class="sidebar-title">Vitesse sur 48 heures</h2>
          <canvas id="speedChart" height="150"></canvas>
       </div>
       <div class="bloc">
        <h2 class="sidebar-title">Historique classement</h2>
        <div class="tableOverflow">
          <table cellspacing="0" id="positionHistory">
            <thead>
              <tr>
                <th>Jour</th>
                <th>classement</th>
                <th>VMG</th>
              </tr>
              <tbody></tbody>
            </thead>
          </table>
        </div>
        <div class="gradient"></div>
        </div>
        <div class="bloc metrics">
          <div><div>Distance restante</div><div id="data_dist">--</div></div>
          <div><div>VMG MAX</div><div id="data_vmgmax">--</div></div>
        </div>
      </div>
    </div>

    <script>
    window.onload = function() {
      var depart = new Date(2020, 10, 8, 14, 20);
      var dateNow = new Date();
      var timerdelta = Math.abs(dateNow -depart) / 1000;
                
      function windcolor(force){
        var colors = ['#ffffff', '#eaf0db', '#dfdfb1', '#e1ca7c', '#ffa71d', '#ff8b1b', '#f97025', '#ef5532', '#e03a42', '#cc1e55', '#b1016d', '#8b008b'];
          if(force <=1){
            return colors[0];
          }
          if(force <=5){
            return colors[1];
          }
          if(force <=11){
            return colors[2];
          }
          if(force <=19){
            return colors[3];
          }
          if(force <=28){
            return colors[4];
          }
          if(force <=38){
            return colors[5];
          }
          if(force <=49){
            return colors[6];
          }
          if(force <=61){
            return colors[7];
          }
          if(force <=74){
            return colors[8];
          }
          if(force <=88){
            return colors[9];
          }
          if(force <=102){
            return colors[10];
          }
          if(force <=112){
            return colors[11];
          }
          if(force <=117){
            return colors[12];
          }
          return colors[18];
      }

      var timer = new easytimer.Timer();
      timer.start({precision: 'seconds', startValues: {seconds: timerdelta}});
      timer.addEventListener('secondsUpdated', function (e) {
          $('#timer .days').html(('0' + timer.getTimeValues().days).slice(-2));
          $('#timer .hours').html(('0' + timer.getTimeValues().hours).slice(-2));
          $('#timer .minutes').html(('0' + timer.getTimeValues().minutes).slice(-2));
          $('#timer .seconds').html(('0' + timer.getTimeValues().seconds).slice(-2));
      });

      // ----- CARTO ----- //

      // var
      var startTime = new Date(Date.UTC(GFS_server_year, GFS_server_month - 1, GFS_server_day, GFS_server_hour));
      var actualTime = new Date(Date.UTC(GFS_server_year, GFS_server_month - 1, GFS_server_day, GFS_server_hour + 6)); //actual time is about 6 hours ahead to the first forecast timestep
      var endTime = new Date(Date.UTC(GFS_server_year, GFS_server_month - 1, GFS_server_day, GFS_server_hour + ((GFS_timesteps-1)*GFS_interval)));
      var dataTimeInterval = startTime.toISOString() + "/" + endTime.toISOString();
      var actualInterval = GFS_interval*2 ; // show only every second available timestep (GFS_interval is "3" hours
      var dataPeriod = "PT" + (actualInterval) + "H";

      function hexToRgb(hex) {
        var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return parseInt(result[1], 16) +', '+ parseInt(result[2], 16)+ ', '+ parseInt(result[3], 16);
      }

      function setSideBarChartConfig(label, data, average){
        return {
          type: 'line',
          data: {
            labels: label,
            datasets: [{
              label: 'Speed dataset',
              borderColor: '#01A7FA',
              data: data,
              fill: false,
              pointBorderColor: '#01A7FA',
              pointBackgroundColor: '#01A7FA',
              pointBorderWidth: 4,
              lineTension: 0.2,
              borderWidth:4,
            }]
          },
          options: {
            scales: {
              yAxes: [{
                  ticks: {
                      beginAtZero: true,
                      fontColor: '#FFFFFF',
                      max: 35,
                  },
                  gridLines: {
                    color: "#333A43",
                    zeroLineColor: '#333A43'
                  },
              }],
              xAxes: [{
                ticks: {
                    fontColor: '#FFFFFF'
                },
                gridLines: {
                  zeroLineColor: '#333A43',
                  color: "#333A43",
                  borderDash: [8, 8],
                }
              }]
            },
            legend: {
              display: false
            },
            tooltips: {
              enabled: false
            },
            annotation: {
              annotations: [{
                type: 'line',
                mode: 'horizontal',
                scaleID: 'y-axis-0',
                value: average,
                borderColor: 'rgba(220,20,60, 0.7)',
                borderWidth: 2,
                label: {
                  enabled: false,
                  content: 'Average'
                }
              }]
            }
          }
        };
      }

      // Set map
      var map = L.map(
        'map',
        {
          zoomControl: false,
          timeDimension: true,
          timeDimensionOptions: {
            timeInterval: dataTimeInterval,
            period: dataPeriod,
            currentTime: actualTime
          },
          timeDimensionControl: true,
          timeDimensionControlOptions: {
          position: "bottomright",
          loopButton: false,
          limitSliders: false,
          playButton: false,
          speedSlider: false
        } }).setView({lon: 0, lat: 0}, 2);


        // --- LAYOUTS --- //

        // Add OSM tiles
        var clear = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
        });


        // Add Dark OSM tiles
        var dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
          subdomains: 'abcd',
	        maxZoom: 19,
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
        });


        // Add Imagery tiles
        var satelit = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
          attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        }).addTo(map);


        // Add Zoom control
        L.control.zoom({
            position: 'topright'
        }).addTo(map);


        // Add Polyline Measure
        var optionspoly = {position: 'topright',unit: 'nauticalmiles', showClearControl: true,showBearings: true};
        L.control.polylineMeasure(optionspoly).addTo(map);


        // Navionics Overlay
        var myNavionicsOverlay = new JNC.Leaflet.NavionicsOverlay({
          navKey: 'Navionics_webapi_00583',
          chartType: JNC.NAVIONICS_CHARTS.NAUTICAL,
          isTransparent: false,
          logoPayoff: false,
          zIndex: 1
        });


        // Add openSeaMap Overlay
        var openSeaMap = L.tileLayer('https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png', {
          attribution: 'Map data: &copy; <a href="http://www.openseamap.org">OpenSeaMap</a> contributors'
        }).addTo(map);


        // Wind
        var baseIndex = 1;
        var wind10mBaseURL = 'https://weather.openportguide.org/weather/wind10m/';
        var wind10mBaseName = 'wind10m_{h}h';
        var wind10mName = '';
        var wind10mArray = [];

        var wind10mLayerGroup = new L.layerGroup([], {});
        wind10mArray.length = map.timeDimension._availableTimes.length;
        var actualTimeIndex = map.timeDimension._currentTimeIndex;
        updateLayer(wind10mArray[actualTimeIndex]);

        function updateLayer(Layer){ //updates the actual layer
          wind10mLayerGroup.clearLayers();
          wind10mName = wind10mBaseName.replace(/{h}/g, (actualTimeIndex - baseIndex) * actualInterval);
          
          $.getJSON(wind10mBaseURL + wind10mName + ".json", function(data) {
            this[wind10mName] = L.velocityLayer({
                displayValues: true,
                displayOptions: {
                    velocityType: "Wind",
                    emptyString: "No wind data",
                    angleConvention: "MeteoCW",
                    speedUnit: "kt"
                },
                data: data,
                minVelocity: 0,
                maxVelocity: 30,
                particleAge: 90,
                lineWidth: 2,
                particleMultiplier: 0.0033,
                frameRate: 10,
                colorScale: ['#ffffff', '#ebf4e7', '#d7e9ce', '#c3deb3', '#b0d396', '#ffa91e', '#fc9527', '#f78130', '#f06e38', '#e75a41', '#dc464a', '#cf3155', '#be1b63', '#a90374', '#8b008b']
               });
        
            wind10mLayerGroup.addLayer(this[wind10mName]);
            wind10mArray[actualTimeIndex] = wind10mLayerGroup.getLayer(wind10mLayerGroup.getLayerId(this[wind10mName]));
            wind10mLayerGroup.addTo(map);
          });
        }

        window.setInterval(function() { //check if time index changed
          if (actualTimeIndex != map.timeDimension._currentTimeIndex) {
          actualTimeIndex = map.timeDimension._currentTimeIndex;
          updateLayer(wind10mArray[actualTimeIndex]);
          }
        },100);

        // ------ TERMINATOR ----- //
        var terminator = L.terminator({fillOpacity:0.2}).addTo(map);
        setInterval(function() {
          terminator.setTime();
        }, 60000);

        // ------- DST DATA ------ //
        $.getJSON( "dst.json"+"?"+Math.random(), function( data ) {
          L.polygon(data, {color: "red", weight: 1}).addTo(map);
        }); 
		
		    // ------- AEZ DATA ------ //
        $.getJSON( "aez.json"+"?"+Math.random(), function( data ) {
          var aez=[];
          //Inversion Lat/Lon
          $.each(data, function(index,value){
          
          aez.push([value[1],value[0]]);
          });
          L.polyline(aez, {color: "red", weight: 1}).addTo(map);
        }); 
		
        // ------ SIDEBAR ----- //

        var sidebar = L.control.sidebar('sidebar', {
            position: 'left',
            closeButton: 'true'
        });
        map.addControl(sidebar);

        $('#close').click(function(){sidebar.hide();});

        // ------ BOAT DATA ------ //
        var boatPositions = [];
        var foilerBoatsGroup = [];
        var daggerBoardBoatsGroup = [];
        var foilerTraceGroup = [];
        var daggerBoardTraceGroup = [];

        $.getJSON( "vg2020.json"+"?"+Math.random(), function( data ) {
          $.each( data, function( key, val ) {
            var latlngs = [];
            var lastPosition = null;
            var lastRotation = null;
          
            // --- TRACE ---- //
            $.each( val.classements, function( elemK, elemV ) {
              lastPosition = [elemV.latitude, elemV.longitude];
              lastRotation = elemV.cap;
              latlngs.push(lastPosition);
            });
    
            // Trace boat line
            var trace = L.polyline(latlngs, {color: val.couleur}).addTo(map);

            // ----- MARKER ----- //
            
            // Design boat icon
            var width = 40;
            var height = 60;
            var boatIcon = L.icon({
                iconUrl: 'static/img/markers/' + key + '.png',
                iconSize:     [width, height],
                iconAnchor:   [width/2, width/2]
            });
          
          // Create boat marker
          var boat = L.marker(lastPosition, {id: key, icon: boatIcon, rotationAngle: lastRotation,title:val.skipper});
          
          // Add click on the boat
          boat.on("click", function(event){
            var id = event.sourceTarget.options.id;
            openSidebar(id);
            map.panTo(lastPosition);
          });

          // Group by foiler / daggerBoard
          if (val.isFoiler){
            foilerTraceGroup.push(trace);
            foilerBoatsGroup.push(boat);
          } else {
            daggerBoardTraceGroup.push(trace);
            daggerBoardBoatsGroup.push(boat);
          }
          
          boatPositions.push(lastPosition);
        });

          // add Groups to map
          var foilerTraceLayer = L.layerGroup(foilerTraceGroup).addTo(map);
          var daggerBoardTraceLayer = L.layerGroup(daggerBoardTraceGroup).addTo(map); 
          var foilersLayer = L.layerGroup(foilerBoatsGroup).addLayer(foilerTraceLayer).addTo(map);
          var daggerBoardLayer= L.layerGroup(daggerBoardBoatsGroup).addLayer(daggerBoardTraceLayer).addTo(map);        

          // ----- LAYER CONTROL ---- //

          var baseLayers = {
            "Claire" : clear,
            "Foncé" : dark,
            "Satellite" : satelit
            
          };
          
          var overlays = {
            "OpenSeaMap" : openSeaMap,
            "Navionics" : myNavionicsOverlay,
            "Vent": wind10mLayerGroup,
            "Jour/nuit": terminator,
            'Foilers': foilersLayer,
            "Dérives": daggerBoardLayer,
          };

          layerControl = L.control.layers(baseLayers, overlays, {position: 'topleft'});
          layerControl.addTo(map);

          // autoFit map
          map.fitBounds(boatPositions);

          // Count boat for skipper count
          $('#skipperCount').html(boatPositions.length);


          // ----- SIDEBAR POPULATE FUNCTION ----- //

          function openSidebar(id){
              sidebar.show();
              var skipper = data[id];
              
              var current = skipper.classements.slice(-1)[0];
              
              var vitessePanel = skipper.classements.slice(-12);
              var vitesses = [];
              var labels = [];
              var total = 0;
              
              $.each( vitessePanel, function( i, elem ) {
                vitesses.push(elem.vitesse);
                labels.push(elem.heure.slice(0, -3));
                total += elem.vitesse;
              });

              var average = total / vitessePanel.length;

              // Stuff
              $('#data_skipper_pict').attr('src', 'static/img/avatar/'+id+'.jpg');
              $('#data_skipper_pict').attr('style', 'border-color:'+skipper.couleur+'; box-shadow:0 0 0 10px rgba('+hexToRgb(skipper.couleur)+',0.2);');
              $('#data_skipper').text(skipper.skipper);
              $('#data_team').text(skipper.bateau);
              $('#data_postion').text(current.position);
              $('#data_speed').text(current.vitesse);
              $('#data_heading').text(current.cap+'°');
              $('#data_vent').html('<span>Direction: '+current.Meteo.wind.deg+'°</span><span>'+current.Meteo.wind.speed+'kt</span>');
              $('#data_direction>svg').css('transform', 'rotate('+(current.Meteo.wind.deg - 45) % 360+'deg)');
              $('#data_direction>svg>path').css('fill', windcolor(current.Meteo.wind.speed));
              
              if (typeof current.Meteo.rain !== 'undefined') {
    				    $('#data_pluie').html('<span>Sur 1 heure</span><span>'+current.Meteo.rain["1h"]+'mm</span>');
				      }
              else{
              	$('#data_pluie').html('<span>Sur 1 heure</span><span>0mm</span>');
              }
              
              $('#data_nuage').html('<span>Couverture</span><span>'+current.Meteo.clouds.all+'%</span>');
              $('#data_dist').text(current.DTF+' nm');
              $('#data_vmgmax').text(current.VMG+' nds');

              // Foiler
              if (skipper.isFoiler){
                $('#data_foiler').text('foiler').addClass('foiler').removeClass('derive');
              } else {
                $('#data_foiler').text('Dérive').addClass('derive').removeClass('foiler');
              }

              // Speed chart
              var ctx = document.getElementById('speedChart').getContext('2d');
              var sidebarChart = new Chart(ctx, setSideBarChartConfig(labels, vitesses, average));
          
              // position history
              var htmlData = '';
              var reversedHistory = [];
              $.each(skipper.classements, function(key, val) {
                reversedHistory.push({'day':Math.floor(key/6), ...val});
              });

              $.each(reversedHistory.reverse(), function(key, val) {

               htmlData += '<tr><td><span class="grey">J+</span>'+val.day+' '+val.heure+'</td><td>'+val.position+'</td><td>'+val.VMG+' <span class="grey">kt</span></td></tr>';
              });
              $('#positionHistory>tbody').html(htmlData);
          }

        });
      
      };
    </script>
  </body>
</html>