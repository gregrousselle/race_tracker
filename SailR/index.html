<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Meta -->
    <link rel="apple-touch-icon" sizes="57x57" href="static/favicon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="static/favicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="static/favicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="static/favicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="static/favicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="static/favicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="static/favicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="static/favicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="static/favicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="static/favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="static/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="static/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="static/favicon/favicon-16x16.png">
    <link rel="manifest" href="static/favicon/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-E2XG6MBSDG"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-E2XG6MBSDG');
    </script>
    <title>SailR</title>
    <script src="static/jquery-3.5.1.min.js" ></script>
    <!-- Leaflet -->
    <link rel="stylesheet" href="static/leaflet/leaflet.css"/>
    <script src="static/leaflet/leaflet.js" ></script>
    <!--leaflet-velocity-->
    <link rel="stylesheet" href="static/velocity/leaflet-velocity.css" />
    <script src="static/velocity/leaflet-velocity.js"></script>
    <script src="static/velocity/IE_workarounds.js"></script>
    <!-- add Leafleet rotate -->
    <script type="text/javascript" src="static/leaflet.rotatedMarker.js"></script>
    <!-- add Leafleet terminator -->
    <script src="https://unpkg.com/@joergdietrich/leaflet.terminator"></script>
    <!-- add Leafleet sidebar -->
    <link rel="stylesheet" href="static/leaflet-sidebar/src/L.Control.Sidebar.css" />
    <script src="static/leaflet-sidebar/src/L.Control.Sidebar.js"></script>
    <!--for timeslider-->
    <script type="text/javascript" src="static/timedimension/iso8601.min.js"></script>
    <script type="text/javascript" src="static/timedimension/leaflet.timedimension.noLayers.src.js"></script>
    <link rel="stylesheet" href="static/timedimension/leaflet.timedimension.control.min.css" />
    <!-- load variable values from server-->
    <script type="text/javascript" src="https://weather.openportguide.org/weather/javascript_vars.js"></script>
    <script type="text/javascript" src="https://weather.openportguide.org/weather/javascript_vars_rtofs.js"></script>
    <!-- add Polyline -->
	  <link rel="stylesheet" href="https://ppete2.github.io/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.css" />
    <script src="https://ppete2.github.io/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.js"></script>
    <!-- add Navionics -->
    <link rel="stylesheet" href="https://webapiv2.navionics.com/dist/webapi/webapi.min.css" >
    <script type="text/javascript" src="https://webapiv2.navionics.com/dist/webapi/webapi.min.no-dep.js"></script>
    <!-- add chartjs -->
    <link rel="stylesheet" href="static/chartjs/Chart.min.css" >
    <script type="text/javascript" src="static/chartjs/Chart.min.js"></script>
    <script type="text/javascript" src="static/chartjs-plugin-annotation.js"></script>
    <!-- add timer -->
    <script type="text/javascript" src="static/easytimer.min.js"></script>
    <!-- fontello -->
    <link rel="stylesheet" href="static/fontello/css/fontello.css" />
    <!-- Custom -->
    <link rel="stylesheet" href="static/style.css" />
  </head>
  <body>
    <div class="black-container">
      <div class="container txtheader">Cartographie non officielle du <span class="blue">Vendée-Globe 2020/2021</span></div>
      </div>
      <div id="map"></div>
      <div class="black-container">
        <div class="container chronodata">
          <div id="timer">
            <div>Chronométre</div>
            <div><span class="blue">J+</span><span class="days blue">00</span> <span class="hours">00</span><span class="blue">:</span><span class="minutes">00</span><span class="blue">:</span><span class="seconds">00</span></div>
          </div>
          <div>
            <div>Skippers en course</div>
            <div><span class="blue" id="skipperCount">33</span> / 33</div>
        </div>
      </div>
      <div id="sidebar">
        <button id="close"><i class="icon-cancel-circle"></i></button>
       <div class="header">
          <img id="data_skipper_pict"  src="static/img/avatar/default.jpg" class="skipper_pict" />
          <div>
            <h1 id="data_skipper">--</h1>
            <h2><span id="data_team">--</span><span id="data_foiler" class="boat-type">--</span><h2>
          </div>
       </div>
       <div class="bloc metrics">
         <div><div>Position</div><div id="data_postion">--</div></div>
         <div><div>Vitesse</div><div><span  id="data_speed">--</span> kt</div></div>
         <div><div>Cap</div><div id="data_heading">--</div></div>
       </div>
       <div class="bloc">
          <h2 class="sidebar-title">Vitesse sur 48 heures</h2>
          <canvas id="speedChart" height="150"></canvas>
       </div>
       <div class="bloc">
        <h2 class="sidebar-title">Historique classement</h2>
        <div class="tableOverflow">
          <table cellspacing="0" id="positionHistory">
            <thead>
              <tr>
                <th>Jour</th>
                <th>classement</th>
                <th>VMG</th>
              </tr>
              <tbody></tbody>
            </thead>
          </table>
        </div>
        <div class="gradient"></div>
        </div>
        <div class="bloc metrics">
          <div><div>Distance restante</div><div id="data_dist">--</div></div>
          <div><div>VMG MAX</div><div id="data_vmgmax">--</div></div>
        </div>
      </div>
    </div>

    <script>
    window.onload = function() {
      var depart = new Date(2020, 10, 8, 14, 20);
      var dateNow = new Date();
      var timerdelta = Math.abs(dateNow -depart) / 1000;

      var timer = new easytimer.Timer();
      timer.start({precision: 'seconds', startValues: {seconds: timerdelta}});
      timer.addEventListener('secondsUpdated', function (e) {
          $('#timer .days').html(('0' + timer.getTimeValues().days).slice(-2));
          $('#timer .hours').html(('0' + timer.getTimeValues().hours).slice(-2));
          $('#timer .minutes').html(('0' + timer.getTimeValues().minutes).slice(-2));
          $('#timer .seconds').html(('0' + timer.getTimeValues().seconds).slice(-2));
      });

      // ----- CARTO ----- //

      // var
      var startTime = new Date(Date.UTC(GFS_server_year, GFS_server_month - 1, GFS_server_day, GFS_server_hour));
      var actualTime = new Date(Date.UTC(GFS_server_year, GFS_server_month - 1, GFS_server_day, GFS_server_hour + 6)); //actual time is about 6 hours ahead to the first forecast timestep
      var endTime = new Date(Date.UTC(GFS_server_year, GFS_server_month - 1, GFS_server_day, GFS_server_hour + ((GFS_timesteps-1)*GFS_interval)));
      var dataTimeInterval = startTime.toISOString() + "/" + endTime.toISOString();
      var actualInterval = GFS_interval*2 ; // show only every second available timestep (GFS_interval is "3" hours
      var dataPeriod = "PT" + (actualInterval) + "H";

      function hexToRgb(hex) {
        var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return parseInt(result[1], 16) +', '+ parseInt(result[2], 16)+ ', '+ parseInt(result[3], 16);
      }

      function setSideBarChartConfig(label, data, average){
        return {
          type: 'line',
          data: {
            labels: label,
            datasets: [{
              label: 'Speed dataset',
              borderColor: '#01A7FA',
              data: data,
              fill: false,
              pointBorderColor: '#01A7FA',
              pointBackgroundColor: '#01A7FA',
              pointBorderWidth: 4,
              lineTension: 0.2,
              borderWidth:4,
            }]
          },
          options: {
            scales: {
              yAxes: [{
                  ticks: {
                      beginAtZero: true,
                      fontColor: '#FFFFFF',
                      max: 35,
                  },
                  gridLines: {
                    color: "#333A43",
                    zeroLineColor: '#333A43'
                  },
              }],
              xAxes: [{
                ticks: {
                    fontColor: '#FFFFFF'
                },
                gridLines: {
                  zeroLineColor: '#333A43',
                  color: "#333A43",
                  borderDash: [8, 8],
                }
              }]
            },
            legend: {
              display: false
            },
            tooltips: {
              enabled: false
            },
            annotation: {
              annotations: [{
                type: 'line',
                mode: 'horizontal',
                scaleID: 'y-axis-0',
                value: average,
                borderColor: 'rgba(220,20,60, 0.7)',
                borderWidth: 2,
                label: {
                  enabled: false,
                  content: 'Average'
                }
              }]
            }
          }
        };
      }

      // Set map
      var map = L.map(
        'map',
        {
          zoomControl: false,
          timeDimension: true,
          timeDimensionOptions: {
            timeInterval: dataTimeInterval,
            period: dataPeriod,
            currentTime: actualTime
          },
          timeDimensionControl: true,
          timeDimensionControlOptions: {
          position: "bottomright",
          loopButton: false,
          limitSliders: false,
          playButton: false,
          speedSlider: false
        } }).setView({lon: 0, lat: 0}, 2);


        // --- LAYOUTS --- //

        // Add OSM tiles
        var clear = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
        });


        // Add Dark OSM tiles
        var dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
          subdomains: 'abcd',
	        maxZoom: 19,
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
        });


        // Add Imagery tiles
        var satelit = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
          attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        }).addTo(map);


        // Add Zoom control
        L.control.zoom({
            position: 'topright'
        }).addTo(map);


        // Add Polyline Measure
        var optionspoly = {position: 'topright',unit: 'nauticalmiles', showClearControl: true,showBearings: true};
        L.control.polylineMeasure(optionspoly).addTo(map);


        // Navionics Overlay
        // var myNavionicsOverlay = new JNC.Leaflet.NavionicsOverlay({
        //   navKey: 'Navionics_webapi_00583',
        //   chartType: JNC.NAVIONICS_CHARTS.NAUTICAL,
        //   isTransparent: false,
        //   logoPayoff: false,
        //   zIndex: 1
        // }).addTo(map);


        // Add openSeaMap Overlay
        var openSeaMap = L.tileLayer('https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png', {
          attribution: 'Map data: &copy; <a href="http://www.openseamap.org">OpenSeaMap</a> contributors'
        }).addTo(map);


        // Wind
        var baseIndex = 1;
        var wind10mBaseURL = 'https://weather.openportguide.org/weather/wind10m/';
        var wind10mBaseName = 'wind10m_{h}h';
        var wind10mName = '';
        var wind10mArray = [];

        var wind10mLayerGroup = new L.layerGroup([], {});
        wind10mArray.length = map.timeDimension._availableTimes.length;
        var actualTimeIndex = map.timeDimension._currentTimeIndex;
        updateLayer(wind10mArray[actualTimeIndex]);

        function updateLayer(Layer){ //updates the actual layer
          wind10mLayerGroup.clearLayers();
          wind10mName = wind10mBaseName.replace(/{h}/g, (actualTimeIndex - baseIndex) * actualInterval);
          
          $.getJSON(wind10mBaseURL + wind10mName + ".json", function(data) {
            this[wind10mName] = L.velocityLayer({
                displayValues: true,
                displayOptions: {
                    velocityType: "Wind",
                    emptyString: "No wind data",
                    angleConvention: "MeteoCW",
                    speedUnit: "kt"
                },
                data: data,
                minVelocity: 0,
                maxVelocity: 30,
                particleAge: 90,
                lineWidth: 2,
                particleMultiplier: 0.0033,
                frameRate: 18,
                //colorScale: ["#2468b4", "#3c9dc2", "#80cdc1", "#97daa8", "#c6e7b5", "#eef7d9", "#ffee9f", "#fcd97d", "#ffb664", "#fc964b", "#fa7034", "#f54020", "#ed2d1c", "#dc1820", "#b40023"]
                //colorScale: ['#ffffcc', '#f7eebf', '#f0dcb2', '#e8cba5', '#dfba98', '#d7aa8b', '#ce997f', '#c58973', '#bc7867', '#b3685b', '#a95750', '#9f4645', '#95343a', '#8b2030', '#800026']
                colorScale: ['#ffffff', '#ebf4e7', '#d7e9ce', '#c3deb3', '#b0d396', '#ffa91e', '#fc9527', '#f78130', '#f06e38', '#e75a41', '#dc464a', '#cf3155', '#be1b63', '#a90374', '#8b008b']
                //colorScale: ['#f8fbff', '#e7ebf4', '#d7dbe9', '#c7cbde', '#b7bbd3', '#a7acc8', '#979dbe', '#878eb3', '#7780a9', '#68719e', '#586394', '#485689', '#37497f', '#243c75', '#07306b']
              });
        
            wind10mLayerGroup.addLayer(this[wind10mName]);
            wind10mArray[actualTimeIndex] = wind10mLayerGroup.getLayer(wind10mLayerGroup.getLayerId(this[wind10mName]));
            wind10mLayerGroup.addTo(map);
          });
        }

        window.setInterval(function() { //check if time index changed
          if (actualTimeIndex != map.timeDimension._currentTimeIndex) {
          actualTimeIndex = map.timeDimension._currentTimeIndex;
          updateLayer(wind10mArray[actualTimeIndex]);
          }
        },100);

        // ------ TERMINATOR ----- //
        var terminator = L.terminator({fillOpacity:0.2}).addTo(map);
        setInterval(function() {
          terminator.setTime();
        }, 60000);

        // ------- DST DATA ------ //
        $.getJSON( "dst.json"+"?"+Math.random(), function( data ) {
          L.polygon(data, {color: "red", weight: 1}).addTo(map);
        }); 
		
		// ------- AEZ DATA ------ //
		$.getJSON( "aez.json"+"?"+Math.random(), function( data ) {
			var aez=[];
			//Inversion Lat/Lon
			$.each(data, function(index,value){
			
			aez.push([value[1],value[0]]);
			});
          L.polyline(aez, {color: "red", weight: 1}).addTo(map);
        }); 
		
        // ------ SIDEBAR ----- //

        var sidebar = L.control.sidebar('sidebar', {
            position: 'left',
            closeButton: 'true'
        });
        map.addControl(sidebar);

        $('#close').click(function(){sidebar.hide();});

        // ------ BOAT DATA ------ //
        var boatPositions = [];
        var foilerBoatsGroup = [];
        var daggerBoardBoatsGroup = [];
        var foilerTraceGroup = [];
        var daggerBoardTraceGroup = [];

        $.getJSON( "vg2020.json"+"?"+Math.random(), function( data ) {
          $.each( data, function( key, val ) {
            var latlngs = [];
            var lastPosition = null;
            var lastRotation = null;
          
            // --- TRACE ---- //
            $.each( val.classements, function( elemK, elemV ) {
              lastPosition = [elemV.latitude, elemV.longitude];
              lastRotation = elemV.cap;
              latlngs.push(lastPosition);
            });
    
            // Trace boat line
            var trace = L.polyline(latlngs, {color: val.couleur}).addTo(map);

            // ----- MARKER ----- //
            
            // Design boat icon
            var width = 40;
            var height = 60;
            var boatIcon = L.icon({
                iconUrl: 'static/img/markers/' + key + '.png',
                iconSize:     [width, height],
                iconAnchor:   [width/2, width/2]
            });
          
          // Create boat marker
          var boat = L.marker(lastPosition, {id: key, icon: boatIcon, rotationAngle: lastRotation,title:val.skipper});
          
          // Add click on the boat
          boat.on("click", function(event){
            var id = event.sourceTarget.options.id;
            openSidebar(id);
          });

          // Group by foiler / daggerBoard
          if (val.isFoiler){
            foilerTraceGroup.push(trace);
            foilerBoatsGroup.push(boat);
          } else {
            daggerBoardTraceGroup.push(trace);
            daggerBoardBoatsGroup.push(boat);
          }
          
          boatPositions.push(lastPosition);
        });

          // add Groups to map
          var foilerTraceLayer = L.layerGroup(foilerTraceGroup).addTo(map);
          var daggerBoardTraceLayer = L.layerGroup(daggerBoardTraceGroup).addTo(map); 
          var foilersLayer = L.layerGroup(foilerBoatsGroup).addLayer(foilerTraceLayer).addTo(map);
          var daggerBoardLayer= L.layerGroup(daggerBoardBoatsGroup).addLayer(daggerBoardTraceLayer).addTo(map);        

          // ----- LAYER CONTROL ---- //

          var baseLayers = {
            "Claire" : clear,
            "Foncé" : dark,
            "Satellite" : satelit
            
          };
          
          var overlays = {
            "OpenSeaMap" : openSeaMap,
            "Vent": wind10mLayerGroup,
            "Jour/nuit": terminator,
            'Foilers': foilersLayer,
            "Dérives": daggerBoardLayer,
            //"Navionics" : myNavionicsOverlay
          };

          layerControl = L.control.layers(baseLayers, overlays, {position: 'topleft'});
          layerControl.addTo(map);

          // autoFit map
          map.fitBounds(boatPositions);

          // Count boat for skipper count
          $('#skipperCount').html(boatPositions.length);


          // ----- SIDEBAR POPULATE FUNCTION ----- //

          function openSidebar(id){
              sidebar.show();
              var skipper = data[id];
              
              var current = skipper.classements.slice(-1)[0];
              
              var vitessePanel = skipper.classements.slice(-12);
              var vitesses = [];
              var labels = [];
              var total = 0;
              
              $.each( vitessePanel, function( i, elem ) {
                vitesses.push(elem.vitesse);
                labels.push(elem.heure.slice(0, -3));
                total += elem.vitesse;
              });

              var average = total / vitessePanel.length;

              // Stuff
              $('#data_skipper_pict').attr('src', 'static/img/avatar/'+id+'.jpg');
              $('#data_skipper_pict').attr('style', 'border-color:'+skipper.couleur+'; box-shadow:0 0 0 10px rgba('+hexToRgb(skipper.couleur)+',0.2);');
              $('#data_skipper').text(skipper.skipper);
              $('#data_team').text(skipper.bateau);
              $('#data_postion').text(current.position);
              $('#data_speed').text(current.vitesse);
              $('#data_heading').text(current.cap+'°');
              $('#data_dist').text(current.DTF+' nm');
              $('#data_vmgmax').text(current.VMG+' nds');

              // Foiler
              if (skipper.isFoiler){
                $('#data_foiler').text('foiler').addClass('foiler').removeClass('derive');
              } else {
                $('#data_foiler').text('Dérive').addClass('derive').removeClass('foiler');
              }

              // Speed chart
              var ctx = document.getElementById('speedChart').getContext('2d');
              var sidebarChart = new Chart(ctx, setSideBarChartConfig(labels, vitesses, average));
          
              // position history
              var htmlData = '';
              $.each(skipper.classements, function(key, val) {

               htmlData += '<tr><td><span class="grey">J+</span>'+Math.floor(key/4)+' '+val.heure+'</td><td>'+val.position+'</td><td>'+val.VMG+' <span class="grey">kt</span></td></tr>';
              });
              $('#positionHistory>tbody').html(htmlData);
          }

        });
      
      };
    </script>
  </body>
</html>